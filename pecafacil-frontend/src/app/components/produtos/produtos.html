<div class="produtos-page">

  <!-- CABE√áALHO -->
  <div class="page-header">
    <div>
      <h1>Gest√£o de Pe√ßas e Produtos</h1>
      <p>Controle de estoque da oficina</p>
    </div>

    <button class="btn-primary" type="button" (click)="abrirModalNovo()">
      + Novo Produto
    </button>
  </div>

  <!-- CARD DE FILTROS -->
  <div class="filters-card">
    <div class="filters-header">
      <span class="filters-icon">‚ö≤</span>
      <span>Filtros de Busca</span>
    </div>

    <div class="filters-grid">
      <!-- BUSCA GERAL -->
      <div class="filter-group filter-wide">
        <label>Buscar por c√≥digo, nome, descri√ß√£o ou local</label>
        <div class="input-with-icon">
          <span>üîç</span>
          <input
            type="text"
            [(ngModel)]="filtro"
            name="filtro"
            placeholder="Ex: PCA-001, √≥leo, filtro..."
            autocomplete="off"
          />
        </div>
      </div>

      <!-- STATUS -->
      <div class="filter-group">
        <label>Status</label>
        <select [(ngModel)]="statusFiltro" name="statusFiltro">
          <option value="todos">Todos</option>
          <option value="disponiveis">Dispon√≠veis</option>
          <option value="baixo">Baixo estoque</option>
          <option value="esgotados">Esgotados</option>
        </select>
      </div>

      <!-- LOCAL -->
      <div class="filter-group">
        <label>Local</label>
        <select [(ngModel)]="localFiltro" name="localFiltro">
          <option value="todos">Todos</option>
          <option *ngFor="let loc of locaisDisponiveis" [value]="loc">
            {{ loc }}
          </option>
        </select>
      </div>
    </div>
  </div>

  <!-- CARDS DE RESUMO -->
  <div class="stats-row">
    <div class="stat-card">
      <span class="stat-label">Total de Itens</span>
      <span class="stat-value">{{ totalItens }}</span>
    </div>

    <div class="stat-card">
      <span class="stat-label">Dispon√≠veis</span>
      <span class="stat-value positive">{{ disponiveis }}</span>
    </div>

    <div class="stat-card">
      <span class="stat-label">Baixo Estoque</span>
      <span class="stat-value warning">{{ baixoEstoqueCount }}</span>
    </div>

    <div class="stat-card">
      <span class="stat-label">Esgotados</span>
      <span class="stat-value danger">{{ esgotados }}</span>
    </div>
  </div>

  <!-- LISTA / TABELA DE PRODUTOS -->
  <div class="list-card">
    <table class="produtos-table">
      <thead>
        <tr>
          <th></th>
          <th>Local</th>
          <th>Produto</th>
          <th>Descri√ß√£o</th>
          <th>Pre√ßo Un.</th>
          <th>Qtd.</th>
          <th>Marca</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>

      <tbody>
        <ng-container *ngFor="let p of produtosFiltrados">
          <tr>
            <td class="seta-cell">
              <button
                class="seta"
                type="button"
                (click)="p.expandido = !p.expandido"
                [attr.aria-expanded]="p.expandido"
              >
                <span [innerHTML]="p.expandido ? '&#9660;' : '&#9654;'"></span>
              </button>
            </td>
            <td>{{ p.local || '‚Äî' }}</td>
            <td>{{ p.nome }}</td>
            <td class="col-descricao">{{ p.descricao }}</td>
            <td>{{ p.preco | currency:'BRL':'symbol-narrow' }}</td>

            <td class="col-qtd">
              <span
                [ngClass]="{
                  'badge-qtd-esgotado': isEsgotado(p),
                  'badge-qtd-baixo': !isEsgotado(p) && isBaixoEstoque(p)
                }"
              >
                {{ p.quantidade ?? 0 }}
              </span>
            </td>

            <td>{{ p.marca }}</td>
            <td class="col-acoes">
              <button
                class="btn-ghost"
                type="button"
                (click)="abrirMov(p, 'entrada')"
              >
                Entrada
              </button>
              <button
                class="btn-ghost warning"
                type="button"
                (click)="abrirMov(p, 'saida')"
              >
                Sa√≠da
              </button>
              <button
                class="btn-ghost danger"
                type="button"
                (click)="excluir(p.id!)"
                *ngIf="isAdmin"
              >
                Excluir
              </button>
            </td>
          </tr>

          <!-- LINHA EXPANDIDA -->
          <tr *ngIf="p.expandido" class="detalhes-row">
            <td colspan="8">
              <div class="detalhes">
                <p><strong>Descri√ß√£o:</strong> {{ p.descricao }}</p>
                <p><strong>Marca / Fornecedor:</strong> {{ p.marca }}</p>
                <p><strong>Estoque m√≠nimo:</strong> {{ p.estoqueMinimo || '‚Äî' }}</p>
                <p>
                  <strong>√öltima Entrada:</strong>
                  {{
                    p.dataUltimaEntrada
                      ? (p.dataUltimaEntrada | date:'dd/MM/yyyy HH:mm')
                      : '‚Äî'
                  }}
                </p>
                <p>
                  <strong>√öltima Sa√≠da:</strong>
                  {{
                    p.dataUltimaSaida
                      ? (p.dataUltimaSaida | date:'dd/MM/yyyy HH:mm')
                      : '‚Äî'
                  }}
                </p>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>

    <div class="sem-produtos" *ngIf="produtosFiltrados.length === 0">
      Nenhum produto encontrado com os filtros atuais.
    </div>
  </div>

  <!-- MODAL NOVO PRODUTO -->
  <div
    class="modal-backdrop"
    *ngIf="mostrarModalNovo"
    role="dialog"
    aria-modal="true"
  >
    <div class="modal">
      <div class="modal-header">
        <h2>Novo Produto</h2>
        <button
          type="button"
          class="close-btn"
          (click)="fecharModalNovo()"
          aria-label="Fechar"
        >
          √ó
        </button>
      </div>

      <form (ngSubmit)="salvarProduto()" #produtoForm="ngForm">
        <div class="modal-body">
          <div class="form-grid">
            <input
              type="text"
              placeholder="Nome do produto"
              [(ngModel)]="novoProduto.nome"
              name="novoNome"
              required
            />

            <input
              type="text"
              placeholder="Descri√ß√£o do produto"
              [(ngModel)]="novoProduto.descricao"
              name="novoDescricao"
              required
            />

            <input
              type="number"
              placeholder="Pre√ßo (R$)"
              [(ngModel)]="novoProduto.preco"
              name="novoPreco"
              step="0.01"
              min="0"
              required
            />

            <input
              type="number"
              placeholder="Estoque m√≠nimo"
              [(ngModel)]="novoProduto.estoqueMinimo"
              name="novoEstoqueMinimo"
              min="0"
              required
            />

            <input
              type="number"
              placeholder="Quantidade em estoque"
              [(ngModel)]="novoProduto.quantidade"
              name="novoQuantidade"
              min="0"
              required
            />

            <input
              type="text"
              placeholder="Marca / Fornecedor"
              [(ngModel)]="novoProduto.marca"
              name="novoMarca"
              required
            />

            <input
              type="text"
              placeholder="Local (ex: Prateleira A-12)"
              [(ngModel)]="novoProduto.local"
              name="novoLocal"
              required
            />
          </div>
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn-ghost"
            (click)="fecharModalNovo()"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="btn-primary"
            [disabled]="produtoForm.invalid"
          >
            Salvar produto
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL DE ENTRADA / SA√çDA -->
  <div
    class="modal-backdrop"
    *ngIf="mostrarModalMov"
    role="dialog"
    aria-modal="true"
  >
    <div class="modal small">
      <div class="modal-header">
        <h2>
          {{ tipoMov === 'entrada' ? 'Registrar entrada' : 'Registrar sa√≠da' }}
        </h2>
        <button
          type="button"
          class="close-btn"
          (click)="fecharMov()"
          aria-label="Fechar"
        >
          √ó
        </button>
      </div>

      <div class="modal-body">
        <p class="modal-produto-nome">{{ produtoSelecionado?.nome }}</p>
        <p class="modal-produto-info">
          Estoque atual:
          <strong>{{ produtoSelecionado?.quantidade ?? 0 }}</strong>
        </p>

        <label for="qtdMov">Quantidade</label>
        <input
          id="qtdMov"
          type="number"
          min="1"
          [(ngModel)]="quantidadeMov"
          name="quantidadeMov"
          autocomplete="off"
        />
      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="btn-ghost"
          (click)="fecharMov()"
        >
          Cancelar
        </button>
        <button
          type="button"
          class="btn-primary"
          (click)="confirmarMov()"
          [disabled]="!quantidadeMov || quantidadeMov <= 0"
        >
          Confirmar
        </button>
      </div>
    </div>
  </div>

</div>
