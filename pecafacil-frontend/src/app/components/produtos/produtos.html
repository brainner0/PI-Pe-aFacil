<div class="container">
  <!-- Header -->
  <div class="audit-header">
    <div class="header-content">
      <h1>
        <span class="header-icon">üì¶</span>
        Gest√£o de Pe√ßas e Produtos
      </h1>
      <p>Controle de estoque e movimenta√ß√µes da oficina</p>
    </div>

    <!-- Barra de pesquisa -->
    <div class="search-container">
      <span class="search-icon">üîç</span>
      <input
        type="text"
        class="search-input"
        placeholder="Pesquisar produtos..."
        [(ngModel)]="filtro"
        name="filtro"
        autocomplete="off"
      />
    </div>
  </div>

  <!-- Linha de resumo + bot√£o -->
  <div class="summary-row">
    <div class="summary-card">
      <span class="summary-label">Total de itens</span>
      <span class="summary-value">{{ totalItens }}</span>
    </div>

    <div class="summary-card">
      <span class="summary-label">Dispon√≠veis</span>
      <span class="summary-value summary-positive">{{ disponiveis }}</span>
    </div>

    <div class="summary-card">
      <span class="summary-label">Baixo estoque</span>
      <span class="summary-value summary-warning">{{ baixoEstoqueCount }}</span>
    </div>

    <div class="summary-card">
      <span class="summary-label">Esgotados</span>
      <span class="summary-value summary-danger">{{ esgotados }}</span>
    </div>

    <div class="summary-actions">
      <button class="primary-btn" type="button" (click)="abrirModalNovo()">
        + Novo Produto
      </button>
    </div>
  </div>

  <!-- Card da tabela -->
  <div class="table-card">
    <table class="table">
      <thead>
        <tr>
          <th></th>
          <th>C√≥digo</th>
          <th>Produto</th>
          <th>Local</th>
          <th>Qtd.</th>
          <th>Est. M√≠n.</th>
          <th>Pre√ßo Un.</th>
          <th>Marca</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>

      <tbody>
        <ng-container *ngFor="let p of produtosFiltrados">
          <tr>
            <!-- seta expandir -->
            <td class="seta-cell">
              <button
                class="seta"
                type="button"
                (click)="p.expandido = !p.expandido"
                [attr.aria-expanded]="p.expandido"
              >
                <span [innerHTML]="p.expandido ? '&#9660;' : '&#9654;'"></span>
              </button>
            </td>

            <td>
              <strong *ngIf="p.id; else semId">#{{ p.id }}</strong>
              <ng-template #semId>‚Äî</ng-template>
            </td>

            <td class="col-nome">
              <div class="prod-name">
                <span class="prod-titulo">{{ p.nome }}</span>
                <span class="prod-desc-curta">{{ p.descricao }}</span>
              </div>
            </td>

            <td>{{ p.local || '‚Äî' }}</td>

            <td class="col-qtd">
              <span
                class="badge-qtd"
                [ngClass]="{
                  'badge-qtd-esgotado': isEsgotado(p),
                  'badge-qtd-baixo': !isEsgotado(p) && isBaixoEstoque(p)
                }"
              > 
                {{ p.quantidade ?? 0 }}
              </span>
            </td>

            <td>
              <span class="badge-minimo">
                {{ p.estoqueMinimo ?? 0 }}
              </span>
            </td>

            <td>
              {{ p.preco | currency:'BRL':'symbol-narrow' }}
            </td>

            <td>{{ p.marca }}</td>

            <td class="col-acoes">
              <button
                class="ghost-btn"
                type="button"
                (click)="abrirMov(p, 'entrada')"
              >
                Entrada
              </button>
              <button
                class="ghost-btn ghost-warning"
                type="button"
                (click)="abrirMov(p, 'saida')"
              >
                Sa√≠da
              </button>
              <button 
                class="ghost-btn"
                style="color: #007bff; border-color: #007bff;"
                type="button"
                *ngIf="isAdmin" 
                (click)="abrirModalEditar(p)"
              >
                Editar
              </button>
              <button
                class="ghost-btn ghost-danger"
                type="button"
                *ngIf="isAdmin"
                (click)="excluir(p.id!)"
              >
                Excluir
              </button>
            </td>
          </tr>

          <!-- Linha expandida com detalhes -->
          <tr *ngIf="p.expandido">
            <td colspan="9" class="details-cell">
              <div class="details-panel">
                <div class="details-left">
                  <p>
                    <strong>Descri√ß√£o completa:</strong><br />
                    <span>{{ p.descricao }}</span>
                  </p>
                  <p>
                    <strong>Marca / Fornecedor:</strong><br />
                    <span>{{ p.marca }}</span>
                  </p>
                  <p>
                    <strong>Local:</strong>
                    <span>{{ p.local || 'N√£o informado' }}</span>
                  </p>
                </div>

                <div class="details-right">
                  <p>
                    <strong>√öltima entrada:</strong><br />
                    <span>
                      {{
                        p.dataUltimaEntrada
                          ? (p.dataUltimaEntrada | date:'dd/MM/yyyy HH:mm')
                          : '‚Äî'
                      }}
                    </span>
                  </p>
                  <p>
                    <strong>√öltima sa√≠da:</strong><br />
                    <span>
                      {{
                        p.dataUltimaSaida
                          ? (p.dataUltimaSaida | date:'dd/MM/yyyy HH:mm')
                          : '‚Äî'
                      }}
                    </span>
                  </p>
                </div>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>

    <!-- Estado vazio -->
    <div class="empty-state" *ngIf="produtosFiltrados.length === 0">
      <div class="empty-icon">üìã</div>
      <h3>Nenhum produto encontrado</h3>
      <p *ngIf="filtro">
        Nenhum resultado para "{{ filtro }}". Tente alterar os termos da pesquisa.
      </p>
      <p *ngIf="!filtro">
        N√£o h√° produtos cadastrados ou o estoque est√° vazio.
      </p>
    </div>
  </div>

  <!-- MODAL NOVO PRODUTO -->
  <div
    class="modal-backdrop"
    *ngIf="mostrarModalNovo"
    role="dialog"
    aria-modal="true"
  >
    <div class="modal">
      <div class="modal-header">
  <h2>{{ editandoId ? 'Editar Produto' : 'Cadastro de novo produto' }}</h2>
  
  <button type="button" class="close-btn" (click)="fecharModalNovo()" aria-label="Fechar">
    √ó
  </button>
</div>

      <form (ngSubmit)="salvarProduto()" #produtoForm="ngForm">
        <div class="modal-body">
          <div class="form-grid">
            <div class="form-group">
              <label>Nome do produto</label>
              <input
                type="text"
                [(ngModel)]="novoProduto.nome"
                name="novoNome"
                required
              />
            </div>

            <div class="form-group">
              <label>Marca / fornecedor</label>
              <input
                type="text"
                [(ngModel)]="novoProduto.marca"
                name="novoMarca"
                required
              />
            </div>

            <div class="form-group">
              <label>Descri√ß√£o</label>
              <input
                type="text"
                [(ngModel)]="novoProduto.descricao"
                name="novoDescricao"
                required
              />
            </div>

            <div class="form-group">
              <label>Local (ex: Prateleira A-12)</label>
              <input
                type="text"
                [(ngModel)]="novoProduto.local"
                name="novoLocal"
                required
              />
            </div>

            <div class="form-group">
              <label>Pre√ßo (R$)</label>
              <input
                type="number"
                [(ngModel)]="novoProduto.preco"
                name="novoPreco"
                min="0"
                step="0.01"
                required
              />
            </div>

            <div class="form-group">
              <label>Estoque m√≠nimo</label>
              <input
                type="number"
                [(ngModel)]="novoProduto.estoqueMinimo"
                name="novoEstoqueMinimo"
                min="0"
                required
              />
            </div>

            <div class="form-group">
              <label>Quantidade em estoque</label>
              <input
                type="number"
                [(ngModel)]="novoProduto.quantidade"
                name="novoQuantidade"
                min="0"
                required
              />
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="ghost-btn"
            (click)="fecharModalNovo()"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="primary-btn"
            [disabled]="produtoForm.invalid"
          >
            Salvar produto
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL DE ENTRADA / SA√çDA -->
  <div
    class="modal-backdrop"
    *ngIf="mostrarModalMov"
    role="dialog"
    aria-modal="true"
  >
    <div class="modal modal-small">
      <div class="modal-header">
        <h2>
          {{ tipoMov === 'entrada' ? 'Registrar entrada' : 'Registrar sa√≠da' }}
        </h2>
        <button
          type="button"
          class="close-btn"
          (click)="fecharMov()"
          aria-label="Fechar"
        >
          √ó
        </button>
      </div>

      <div class="modal-body">
        <p class="modal-produto-nome">{{ produtoSelecionado?.nome }}</p>
        <p class="modal-produto-info">
          Estoque atual:
          <strong>{{ produtoSelecionado?.quantidade ?? 0 }}</strong>
        </p>

        <label for="qtdMov">Quantidade</label>
        <input
          id="qtdMov"
          type="number"
          min="1"
          [(ngModel)]="quantidadeMov"
          name="quantidadeMov"
          autocomplete="off"
        />
      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="ghost-btn"
          (click)="fecharMov()"
        >
          Cancelar
        </button>
        <button
          type="button"
          class="primary-btn"
          (click)="confirmarMov()"
          [disabled]="!quantidadeMov || quantidadeMov <= 0"
        >
          Confirmar
        </button>
      </div>
    </div>
  </div>
</div>
